version: '3.9'

services:
  # ============================================================================
  # PostgreSQL Database - Primary Data Storage
  # ============================================================================
  db:
    image: postgres:16-alpine
    container_name: cafirm_postgres
    environment:
      POSTGRES_DB: compliance_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data/
      - ./backups:/backups  # Mount backup directory
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d compliance_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - cafirm_network
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=1MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB

  # ============================================================================
  # Redis - Cache & Message Broker
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: cafirm_redis
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:-redispassword}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --tcp-backlog 511
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
      - cafirm_network

  # ============================================================================
  # Django Web Application
  # ============================================================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: 3.10
    container_name: cafirm_web
    command: >
      sh -c "
        python manage.py collectstatic --noinput &&
        python manage.py migrate &&
        python manage.py create_admin &&
        gunicorn core.wsgi:application 
          --bind 0.0.0.0:8000 
          --workers 4
          --worker-class gevent
          --worker-connections 1000
          --max-requests 1000
          --max-requests-jitter 50
          --timeout 30
          --graceful-timeout 30
          --keep-alive 5
          --log-level info
          --access-logfile -
          --error-logfile -
      "
    volumes:
      - .:/app
      - static_data:/app/staticfiles
      - media_data:/app/media
      - logs_data:/app/logs
    ports:
      - "8082:8000"
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://user:${DB_PASSWORD:-password}@db:5432/compliance_db
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/2
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - cafirm_network

  # ============================================================================
  # Celery Worker - Background Tasks
  # ============================================================================
  celery_worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cafirm_celery_worker
    command: >
      celery -A core worker
      --loglevel=info
      --concurrency=4
      --max-tasks-per-child=1000
      --time-limit=1800
      --soft-time-limit=1500
      --queues=default,services,users
    volumes:
      - .:/app
      - media_data:/app/media
      - logs_data:/app/logs
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://user:${DB_PASSWORD:-password}@db:5432/compliance_db
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/2
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "celery -A core inspect ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - cafirm_network

  # ============================================================================
  # Celery Beat - Scheduled Tasks (Cron Jobs)
  # ============================================================================
  celery_beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cafirm_celery_beat
    command: >
      celery -A core beat
      --loglevel=info
      --scheduler django_celery_beat.schedulers:DatabaseScheduler
      --pidfile=/tmp/celerybeat.pid
    volumes:
      - .:/app
      - logs_data:/app/logs
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://user:${DB_PASSWORD:-password}@db:5432/compliance_db
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/2
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - cafirm_network

  # ============================================================================
  # Celery Flower - Task Monitoring (Optional)
  # ============================================================================
  flower:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cafirm_flower
    command: >
      celery -A core flower
      --port=5555
      --url_prefix=flower
      --basic_auth=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}
    volumes:
      - .:/app
      - flower_data:/app/flower_data
    ports:
      - "5555:5555"
    env_file:
      - .env
    environment:
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/2
    depends_on:
      - redis
      - celery_worker
    restart: unless-stopped
    networks:
      - cafirm_network

  # ============================================================================
  # Nginx - Reverse Proxy (Optional but recommended for production)
  # ============================================================================
  # nginx:
  #   image: nginx:alpine
  #   container_name: cafirm_nginx
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - static_data:/usr/share/nginx/html/static:ro
  #     - media_data:/usr/share/nginx/html/media:ro
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   depends_on:
  #     - web
  #   restart: unless-stopped
  #   networks:
  #     - cafirm_network

# ============================================================================
# Volumes - Persistent Storage
# ============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  static_data:
    driver: local
  media_data:
    driver: local
  logs_data:
    driver: local
  flower_data:
    driver: local

# ============================================================================
# Networks
# ============================================================================
networks:
  cafirm_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# ============================================================================
# USAGE INSTRUCTIONS
# ============================================================================
# 
# Start all services:
#   docker-compose up -d
# 
# View logs:
#   docker-compose logs -f web
#   docker-compose logs -f celery_worker
# 
# Stop all services:
#   docker-compose down
# 
# Remove all data (WARNING: This deletes the database!):
#   docker-compose down -v
# 
# Rebuild containers after code changes:
#   docker-compose up -d --build
# 
# Execute Django commands:
#   docker-compose exec web python manage.py migrate
#   docker-compose exec web python manage.py createsuperuser
# 
# Database backup:
#   docker-compose exec db pg_dump -U user compliance_db > backup.sql
# 
# Database restore:
#   docker-compose exec -T db psql -U user compliance_db < backup.sql
# 
# Scale workers:
#   docker-compose up -d --scale celery_worker=3
# 
# Health check:
#   curl http://localhost:8082/api/health/